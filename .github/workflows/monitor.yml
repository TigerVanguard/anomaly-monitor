name: Anomaly Monitor Cron

on:
  schedule:
    - cron: '3/10 * * * *'  # 每 10 分钟运行一次，从第 3 分钟开始 (错峰运行)
  workflow_dispatch:      # 允许手动触发

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 赋予写权限以便提交代码
      
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      # 1. 恢复缓存 (在运行脚本之前)
      - name: Restore seen orders cache
        id: restore-cache
        uses: actions/cache/restore@v3
        with:
          path: seen_orders.json
          key: seen-orders-${{ github.run_id }} # 总是尝试恢复最新的，这里 key 只是占位
          restore-keys: |
            seen-orders-
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          
      - name: Run Scanner
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: python monitor.py

      # 2. 保存缓存 (在运行脚本之后)
      # 注意：GitHub Actions Cache 是不可变的，所以每次必须用新的 key
      - name: Save seen orders cache
        if: always() # 即使脚本报错也要尝试保存（视情况而定，通常成功才保存）
        uses: actions/cache/save@v3
        with:
          path: seen_orders.json
          key: seen-orders-${{ github.run_id }}

      # 3. 提交并推送更新后的数据文件 (用于前端展示)
      - name: Commit and push alerts data
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add client/public/data/alerts.json
          # 只有当文件有变化时才提交
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update alerts data [skip ci]" && git push)
